<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Greeting with Accurate Location</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #ffe082, #ffcc80, #ffab91);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 22px;
      padding: 24px 28px;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.18);
      max-width: 420px;
      width: 90%;
      text-align: center;
    }
    .greeting {
      font-size: 32px;
      font-weight: 700;
      color: #4e342e;
      margin-bottom: 4px;
    }
    .time-text {
      font-size: 14px;
      color: #6d4c41;
      margin-bottom: 16px;
    }
    .location-title {
      font-size: 16px;
      font-weight: 600;
      margin-top: 12px;
      margin-bottom: 6px;
      color: #5d4037;
    }
    .location-line {
      font-size: 14px;
      color: #4e342e;
      margin-bottom: 6px;
      line-height: 1.4;
    }
    .small {
      font-size: 12px;
      color: #795548;
    }
    .status {
      font-size: 13px;
      color: #d84315;
      margin-top: 10px;
      min-height: 20px;
    }
    .btn {
      margin-top: 16px;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      background: #ffb74d;
      color: #4e342e;
    }
    .btn:active {
      transform: scale(0.97);
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="greeting" id="greetingText">Loading...</div>
    <div class="time-text" id="timeText"></div>

    <div class="location-title">Your Accurate Location</div>
    <div class="location-line" id="addressLine">Fetching precise locationâ€¦</div>
    <div class="location-line small" id="latLngLine"></div>

    <div class="status" id="statusMsg"></div>

    <button class="btn" onclick="getLocation(true)">Refresh Location</button>
  </div>

  <script>
    // ---------- Time-based Greeting ----------
    function setGreeting() {
      const now = new Date();
      const hour = now.getHours();

      let greeting = "";
      if (hour >= 5 && hour < 12) greeting = "Good Morning â˜€ï¸";
      else if (hour >= 12 && hour < 17) greeting = "Good Afternoon ðŸŒ¤ï¸";
      else if (hour >= 17 && hour < 21) greeting = "Good Evening ðŸŒ‡";
      else greeting = "Good Night ðŸŒ™";

      document.getElementById("greetingText").textContent = greeting;
      document.getElementById("timeText").textContent =
        "Local time: " + now.toLocaleTimeString();
    }

    setGreeting();
    setInterval(setGreeting, 60000); // Update every minute

    // ---------- Reverse Geocoding Function ----------
    async function reverseGeocode(lat, lon) {
      const url =
        `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=19&addressdetails=1`;

      const res = await fetch(url);
      if (!res.ok) throw new Error("Reverse geocoding failed");

      const data = await res.json();
      const addr = data.address || {};

      // Pull VERY detailed address fields
      const building =
        addr.building ||
        addr.house ||
        addr.house_number ||
        addr.mansion ||
        addr.residential ||
        "";

      const amenity = addr.amenity || "";
      const apartment = addr.neighbourhood || addr.suburb || addr.locality || "";
      const road = addr.road || addr.pedestrian || addr.path || "";
      const area = addr.suburb || addr.locality || "";
      const city = addr.city || addr.town || addr.village || addr.county || "";
      const state = addr.state || "";
      const postcode = addr.postcode || "";
      const country = addr.country || "";

      // Build readable line
      let parts = [
        building,
        amenity,
        apartment,
        road,
        area,
        city,
        state,
        postcode,
        country
      ].filter(Boolean);

      let finalAddress = parts.length > 0 ? parts.join(", ") : data.display_name;
      return finalAddress;
    }

    // ---------- GPS & Location ----------
    function getLocation(fromButton = false) {
      const statusMsg = document.getElementById("statusMsg");
      const addressLine = document.getElementById("addressLine");
      const latLngLine = document.getElementById("latLngLine");

      if (!navigator.geolocation) {
        statusMsg.textContent = "Geolocation not supported.";
        return;
      }

      statusMsg.textContent = fromButton
        ? "Refreshing locationâ€¦"
        : "Getting precise GPS locationâ€¦";

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy;

          // Show coordinates
          latLngLine.textContent =
            `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)} (Â±${Math.round(acc)} m)`;

          try {
            const address = await reverseGeocode(lat, lon);
            addressLine.textContent = address;
            statusMsg.textContent = "";
          } catch (e) {
            console.error(e);
            addressLine.textContent =
              "Coordinates found but detailed road/building name missing.";
            statusMsg.textContent = "Reverse geocoding failed.";
          }
        },
        (err) => {
          switch (err.code) {
            case err.PERMISSION_DENIED:
              statusMsg.textContent =
                "Permission denied. Allow GPS to see accurate location.";
              break;
            case err.POSITION_UNAVAILABLE:
              statusMsg.textContent = "Location unavailable.";
              break;
            case err.TIMEOUT:
              statusMsg.textContent = "Location request timed out.";
              break;
            default:
              statusMsg.textContent = "Unexpected error.";
          }

          addressLine.textContent = "Location not available.";
          latLngLine.textContent = "";
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    }

    // On load
    getLocation(false);
  </script>
</body>
</html>
